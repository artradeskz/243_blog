<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech_info_editor</title>
    <!-- Quill —Å—Ç–∏–ª–∏ -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .back-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        
        .back-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .editor-container {
            padding: 20px;
        }
        
        .title-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: 600;
            border: 2px solid #eaeaea;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .title-input:focus {
            border-color: #4b6cb7;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            flex-wrap: wrap;
            gap: 10px;
            border-bottom: 1px solid #eaeaea;
            margin-bottom: 15px;
        }
        
        .format-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .format-btn {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 36px;
            min-width: 36px;
        }
        
        .format-btn:hover {
            background-color: #f0f0f0;
        }
        
        .format-btn.active {
            background-color: #4b6cb7;
            color: white;
            border-color: #4b6cb7;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
        .image-upload-container {
            position: relative;
            display: inline-block;
        }
        
        #image-upload {
            display: none;
        }
        
        .image-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 36px;
            min-width: 36px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .image-upload-label:hover {
            background-color: #f0f0f0;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .action-btn.save {
            background-color: #28a745;
            color: white;
        }
        
        .action-btn.save:hover {
            background-color: #218838;
        }
        
        .action-btn.save:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .action-btn.preview {
            background-color: #17a2b8;
            color: white;
        }
        
        .action-btn.preview:hover {
            background-color: #138496;
        }
        
        .action-btn.preview:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .action-btn.cancel {
            background-color: #6c757d;
            color: white;
        }
        
        .action-btn.cancel:hover {
            background-color: #5a6268;
        }
        
        .action-btn.image {
            background-color: #ff6b35;
            color: white;
        }
        
        .action-btn.image:hover {
            background-color: #e55a2b;
        }
        
        #editor {
            min-height: 500px;
            font-size: 16px;
            line-height: 1.6;
            border: 1px solid #eaeaea;
            border-radius: 8px;
        }
        
        .ql-editor img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        /* –ë–ª–æ–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è */
        .copy-block {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .copy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .copy-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            font-weight: 500;
        }
        
        .copy-btn {
            background-color: #f0f0f0;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.85rem;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .copy-btn:hover {
            background-color: #e0e0e0;
        }
        
        .copy-btn.copied {
            background-color: #10b981;
            color: white;
        }
        
        .copy-text {
            font-family: 'Courier New', monospace;
            background-color: #f9f9f9;
            padding: 12px;
            border-radius: 4px;
            white-space: pre-wrap;
            border-left: 3px solid #4b6cb7;
        }
        
        .status-message {
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-message.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .status-message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .upload-progress {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar {
            width: 0%;
            height: 20px;
            background-color: #4b6cb7;
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .progress-text {
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 2px 0;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: space-between;
            }
            
            .title-input {
                font-size: 1.5rem;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>–†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ç–∞—Ç–µ–π</h1>
            <a href="/" class="back-btn">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </header>
        
        <div class="editor-container">
            <input type="text" id="title" class="title-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏..." required>
            
            <div class="status-message" id="status-message"></div>
            <div class="upload-progress" id="upload-progress">
                <div class="progress-bar" id="progress-bar"></div>
                <div class="progress-text" id="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞: 0%</div>
            </div>
            
            <div class="controls">
                <div class="format-buttons">
                    <button class="format-btn" data-format="bold" title="–ñ–∏—Ä–Ω—ã–π">
                        <b>–ñ</b>
                    </button>
                    <button class="format-btn" data-format="italic" title="–ö—É—Ä—Å–∏–≤">
                        <i>–ö</i>
                    </button>
                    <button class="format-btn" data-format="underline" title="–ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ">
                        <u>–ß</u>
                    </button>
                    <button class="format-btn" data-format="list" value="bullet" title="–ú–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫">
                        ‚Ä¢ List
                    </button>
                    <button class="format-btn" data-format="list" value="ordered" title="–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫">
                        1. List
                    </button>
                    <button class="format-btn" data-format="header" value="1" title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1">
                        H1
                    </button>
                    <button class="format-btn" data-format="header" value="2" title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2">
                        H2
                    </button>
                    <button class="format-btn" id="image-url-btn" title="–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ URL">
                        üñºÔ∏è URL
                    </button>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ -->
                    <div class="image-upload-container">
                        <input type="file" id="image-upload" accept="image/*">
                        <label for="image-upload" class="image-upload-label" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞">
                            üìÅ –§–∞–π–ª
                        </label>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–ª–æ–∫–æ–≤ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è -->
                    <button class="format-btn" id="block-btn" title="–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å [block] —Ç–µ–≥–∏ –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –±–ª–æ–∫–∏">
                        üìã –ë–ª–æ–∫–∏
                    </button>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn cancel" id="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
                    <button class="action-btn preview" id="preview-btn" disabled>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
                    <button class="action-btn save" id="save-btn" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—å—é</button>
                </div>
            </div>
            
            <div id="editor">
                <p>–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å —Å–≤–æ—é —Å—Ç–∞—Ç—å—é –∑–¥–µ—Å—å...</p>
                <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–≥–∏ <code>[block]–≤–∞—à —Ç–µ–∫—Å—Ç[/block]</code> –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–ø–∏—Ä—É–µ–º—ã—Ö –±–ª–æ–∫–æ–≤.</p>
                <p>–ó–∞–≥—Ä—É–∂–∞–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏ "–§–∞–π–ª" –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ URL -->
    <div class="image-modal" id="image-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background-color: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
            <h3 style="margin-bottom: 20px;">–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ URL</h3>
            <input type="text" id="image-url-input" placeholder="–í–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è..." style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="action-btn cancel" id="cancel-image-url">–û—Ç–º–µ–Ω–∞</button>
                <button class="action-btn save" id="insert-image-url">–í—Å—Ç–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Quill –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ -->
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    
    <script>
        // –ü–æ–ª—É—á–∞–µ–º ID —Å—Ç–∞—Ç—å–∏ –∏–∑ URL (–µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');
        let isEditMode = !!postId;
        let currentPostId = postId;
        let quill;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        async function checkAuth() {
            try {
                const response = await fetch('/api/me', { 
                    credentials: 'same-origin' 
                });
                const data = await response.json();
                
                if (!data.user) {
                    window.location.href = '/login.html';
                    return false;
                }
                return true;
            } catch (error) {
                window.location.href = '/login.html';
                return false;
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text, type = 'info') {
            const messageEl = document.getElementById('status-message');
            messageEl.textContent = text;
            messageEl.className = `status-message ${type}`;
            messageEl.style.display = 'block';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –¥–ª—è success/info —Å–æ–æ–±—â–µ–Ω–∏–π
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 3000);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
        function showUploadProgress(percent) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressContainer = document.getElementById('upload-progress');
            
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞: ${percent}%`;
            
            if (percent > 0 && percent < 100) {
                progressContainer.style.display = 'block';
            } else if (percent === 100) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                    progressText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞: 0%';
                }, 1000);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        async function initEditor() {
            const auth = await checkAuth();
            if (!auth) return;

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Quill
            quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: false
                }
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—å–∏, –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
            if (isEditMode) {
                try {
                    showMessage('–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—å–∏...', 'info');
                    await loadPost(currentPostId);
                    showMessage('–°—Ç–∞—Ç—å—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
                } catch (error) {
                    showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—å–∏', 'error');
                }
            }

            // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            document.getElementById('save-btn').disabled = false;
            document.getElementById('preview-btn').disabled = false;

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.querySelectorAll('.format-btn[data-format]').forEach(button => {
                button.addEventListener('click', function() {
                    const format = this.dataset.format;
                    const value = this.value || true;
                    
                    if (format === 'bold' || format === 'italic' || format === 'underline') {
                        quill.format(format, value);
                    } else if (format === 'list') {
                        quill.format('list', value);
                    } else if (format === 'header') {
                        quill.format('header', parseInt(value));
                    }
                });
            });

            // –ö–Ω–æ–ø–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ URL
            document.getElementById('image-url-btn').addEventListener('click', function() {
                document.getElementById('image-modal').style.display = 'flex';
                document.getElementById('image-url-input').focus();
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ URL
            document.getElementById('cancel-image-url').addEventListener('click', function() {
                document.getElementById('image-modal').style.display = 'none';
                document.getElementById('image-url-input').value = '';
            });

            // –í—Å—Ç–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ URL
            document.getElementById('insert-image-url').addEventListener('click', function() {
                const url = document.getElementById('image-url-input').value.trim();
                if (!url) {
                    showMessage('–í–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'warning');
                    return;
                }

                const range = quill.getSelection();
                const position = range ? range.index : quill.getLength();
                
                quill.insertEmbed(position, 'image', url);
                document.getElementById('image-modal').style.display = 'none';
                document.getElementById('image-url-input').value = '';
                showMessage('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ', 'success');
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
            document.getElementById('image-upload').addEventListener('change', async function(e) {
                const file = e.target.files[0];
                
                if (!file) return;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
                if (!file.type.match('image.*')) {
                    showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPG, PNG, GIF –∏ —Ç.–¥.)', 'error');
                    this.value = '';
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showMessage('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 10MB', 'error');
                    this.value = '';
                    return;
                }

                try {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
                    showUploadProgress(10);

                    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
                    const range = quill.getSelection();
                    const position = range ? range.index : quill.getLength();

                    // –í—Å—Ç–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
                    quill.insertText(position, '[–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...]', { color: '#999' });
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    showUploadProgress(30);
                    const imageUrl = await uploadLocalImage(file);
                    
                    if (imageUrl) {
                        // –£–¥–∞–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
                        quill.deleteText(position, 24);
                        
                        // –í—Å—Ç–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        quill.insertEmbed(position, 'image', imageUrl);
                        showUploadProgress(100);
                        showMessage('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ', 'success');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                    showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message, 'error');
                } finally {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ input
                    this.value = '';
                }
            });

            // –ö–Ω–æ–ø–∫–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–æ–≤
            document.getElementById('block-btn').addEventListener('click', function() {
                const content = quill.root.innerHTML;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–µ–≥–∏ [block]
                if (!content.includes('[block]') || !content.includes('[/block]')) {
                    showMessage('–í —Ç–µ–∫—Å—Ç–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ç–µ–≥–æ–≤ [block]...[/block]', 'warning');
                    return;
                }
                
                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–≥–æ–≤ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
                const newContent = content.replace(
                    /\[block\](.*?)\[\/block\]/g, 
                    '<span style="background-color: #fff3cd; padding: 2px 4px; border-radius: 3px; border: 1px solid #ffeaa7;">[block]$1[/block]</span>'
                );
                
                quill.root.innerHTML = newContent;
                showMessage('–¢–µ–≥–∏ [block] –ø–æ–¥—Å–≤–µ—á–µ–Ω—ã. –û–Ω–∏ –±—É–¥—É—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω—ã –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.', 'info');
            });

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—å–∏
            document.getElementById('save-btn').addEventListener('click', savePost);

            // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
            document.getElementById('preview-btn').addEventListener('click', function() {
                const title = document.getElementById('title').value;
                let content = quill.root.innerHTML;
                
                if (!title.trim()) {
                    showMessage('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏', 'warning');
                    return;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                localStorage.setItem('preview_title', title);
                localStorage.setItem('preview_content', content);
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
                window.open('/preview.html', '_blank');
            });

            // –û—Ç–º–µ–Ω–∞
            document.getElementById('cancel-btn').addEventListener('click', function() {
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                    window.location.href = '/';
                }
            });

            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            let autoSaveTimer;
            let hasUnsavedChanges = false;
            
            quill.on('text-change', function() {
                hasUnsavedChanges = true;
                
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    if (hasUnsavedChanges && document.getElementById('title').value.trim()) {
                        autoSaveDraft();
                    }
                }, 30000); // 30 —Å–µ–∫—É–Ω–¥
            });

            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
            function autoSaveDraft() {
                const title = document.getElementById('title').value.trim();
                const content = quill.root.innerHTML;
                
                if (!title) return;
                
                localStorage.setItem('article_draft', JSON.stringify({
                    title: title,
                    content: content,
                    timestamp: new Date().toISOString()
                }));
                
                console.log('–ß–µ—Ä–Ω–æ–≤–∏–∫ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω');
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞
            const draft = localStorage.getItem('article_draft');
            if (draft && !isEditMode) {
                if (confirm('–ù–∞–π–¥–µ–Ω –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫. –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ–≥–æ?')) {
                    try {
                        const draftData = JSON.parse(draft);
                        document.getElementById('title').value = draftData.title;
                        quill.root.innerHTML = draftData.content;
                        showMessage('–ß–µ—Ä–Ω–æ–≤–∏–∫ –∑–∞–≥—Ä—É–∂–µ–Ω', 'info');
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞:', e);
                    }
                }
            }

            // –ó–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?';
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—å–∏
        async function loadPost(id) {
            try {
                const response = await fetch(`/api/post/${id}`);
                if (!response.ok) {
                    throw new Error('–°—Ç–∞—Ç—å—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }
                
                const post = await response.json();
                
                if (post.error) {
                    throw new Error(post.error);
                }
                
                document.getElementById('title').value = post.title || '';
                document.querySelector('h1').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏';
                quill.root.innerHTML = post.content || '';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—å–∏:', error);
                throw error;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function uploadLocalImage(file) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É —Å—Ç–∞—Ç—å–∏ ID
            if (!currentPostId) {
                // –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ —Å—Ç–∞—Ç—å–∏
                const title = document.getElementById('title').value.trim();
                const content = quill.root.innerHTML;
                
                if (!title) {
                    throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏');
                }
                
                showUploadProgress(40);
                
                // –°–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ç—å—é —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ 
                        title: title, 
                        content: '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</p>' 
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞—Ç—å–∏');
                }
                
                const result = await response.json();
                currentPostId = result.id;
                isEditMode = true;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º URL
                window.history.pushState({}, '', `/editor.html?id=${currentPostId}`);
                
                showUploadProgress(60);
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const formData = new FormData();
            formData.append('image', file);
            
            const uploadResponse = await fetch(`/api/upload-image/${currentPostId}`, {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            });
            
            if (!uploadResponse.ok) {
                const error = await uploadResponse.json();
                throw new Error(error.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            }
            
            const uploadResult = await uploadResponse.json();
            return uploadResult.url;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—å–∏
        async function savePost() {
            const title = document.getElementById('title').value.trim();
            let content = quill.root.innerHTML;
            
            if (!title) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏', 'error');
                document.getElementById('title').focus();
                return;
            }
            
            if (!content || content === '<p><br></p>') {
                showMessage('–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏', 'error');
                return;
            }
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–µ–≥–∏ [block] –≤ HTML –±–ª–æ–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            content = processBlockTags(content);
            
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                const saveBtn = document.getElementById('save-btn');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                saveBtn.disabled = true;
                
                const url = isEditMode 
                    ? `/api/post/${currentPostId}` 
                    : '/api/posts';
                
                const method = isEditMode ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ title, content })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    if (!isEditMode) {
                        currentPostId = result.id;
                        isEditMode = true;
                        window.history.pushState({}, '', `/editor.html?id=${currentPostId}`);
                    }
                    
                    // –û—á–∏—â–∞–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫
                    localStorage.removeItem('article_draft');
                    
                    showMessage(
                        isEditMode 
                            ? '–°—Ç–∞—Ç—å—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' 
                            : '–°—Ç–∞—Ç—å—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!',
                        'success'
                    );
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω–∏–π
                    hasUnsavedChanges = false;
                    
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç–∞—Ç—å—é —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        window.location.href = `/post.html?id=${currentPostId}`;
                    }, 1500);
                    
                } else {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—å–∏:', error);
                showMessage(error.message, 'error');
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                const saveBtn = document.getElementById('save-btn');
                saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—å—é';
                saveBtn.disabled = false;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–≥–æ–≤ [block] –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        function processBlockTags(content) {
            let blockCounter = 0;
            
            // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–µ–≥–æ–≤ [block]...[/block]
            const blockRegex = /\[block\](.*?)\[\/block\]/gs;
            
            // –ó–∞–º–µ–Ω—è–µ–º —Ç–µ–≥–∏ –Ω–∞ HTML –±–ª–æ–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            const processedContent = content.replace(blockRegex, function(match, blockContent) {
                blockCounter++;
                const blockId = `block-${Date.now()}-${blockCounter}`;
                
                return `
                    <div class="copy-block">
                        <div class="copy-header">
                            <div class="copy-label">–ë–ª–æ–∫ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è #${blockCounter}</div>
                            <button class="copy-btn" onclick="copyText('${blockId}')" data-block="${blockId}">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                        <div class="copy-text" id="${blockId}">${blockContent.trim()}</div>
                    </div>
                `;
            });
            
            if (blockCounter > 0) {
                showMessage(`–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ ${blockCounter} –±–ª–æ–∫–æ–≤ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è`, 'info');
            }
            
            return processedContent;
        }

        // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ (–¥–ª—è –±–ª–æ–∫–æ–≤)
        window.copyText = async function(blockId) {
            const textElement = document.getElementById(blockId);
            const button = document.querySelector(`[data-block="${blockId}"]`);
            
            if (!textElement || !button) return;
            
            try {
                await navigator.clipboard.writeText(textElement.textContent);
                
                // –ú–µ–Ω—è–µ–º –≤–∏–¥ –∫–Ω–æ–ø–∫–∏
                const originalHTML = button.innerHTML;
                button.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!
                `;
                button.classList.add('copied');
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –≤–∏–¥ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('copied');
                }, 2000);
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                
                // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                const textArea = document.createElement('textarea');
                textArea.value = textElement.textContent;
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    alert('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
                } catch (e) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç');
                }
                
                document.body.removeChild(textArea);
            }
        };

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
        document.getElementById('title').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                quill.focus();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.getElementById('image-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
                document.getElementById('image-url-input').value = '';
            }
        });

        // –í—Å—Ç–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ URL –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter
        document.getElementById('image-url-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('insert-image-url').click();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initEditor);
    </script>
</body>
</html>