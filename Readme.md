# Техническая документация проекта: WYSIWYG Блог с файловым хранилищем

**Версия:** 0.1  
**Последнее обновление:** Декабрь 2025  
**Статус:** Рабочий прототип

## Содержание
1. [Цель и назначение проекта](#цель-и-назначение-проекта)
2. [Архитектура системы](#архитектура-системы)
3. [Технологический стек](#технологический-стек)
4. [Функциональные возможности](#функциональные-возможности)
5. [Структура данных](#структура-данных)
6. [API Endpoints](#api-endpoints)
7. [Рабочий процесс](#рабочий-процесс)
8. [Система безопасности](#система-безопасности)
9. [Установка и запуск](#установка-и-запуск)
10. [Назначение info.json](#назначение-infojson)
11. [Достоинства и недостатки](#достоинства-и-недостатки)
12. [Возможные улучшения](#возможные-улучшения)

## Цель и назначение проекта

**Проект:** WYSIWYG блог с гибридным хранением данных  
**Назначение:** Веб-приложение для ведения блога с полным циклом публикации статей, включая создание, редактирование, публикацию и управление контентом.

**Ключевые особенности:**
- Полноценный WYSIWYG-редактор на основе Quill.js
- Гибридное хранение: метаданные в SQLite, контент в файловой системе
- Автономная система восстановления из файлов
- Поддержка загрузки изображений и интерактивных блоков

## Архитектура системы

### Диаграмма архитектуры

```
┌─────────────────┐     HTTP/HTTPS     ┌─────────────────┐
│   Web Browser   │◄──────────────────►│   Node.js +     │
│   (Frontend)    │                    │   Express       │
└─────────────────┘                    └─────────────────┘
                                               │
                                               ▼
┌─────────────────────────────────────────────────────────┐
│                    Серверный слой                       │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────┐     │
│  │  Session    │  │   Routing   │  │  Middleware  │     │
│  │  Management │  │   Engine    │  │    Layer     │     │
│  └─────────────┘  └─────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────┘
                     │              │
                     ▼              ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────────┐
│   SQLite    │  │   File      │  │   Temporary     │
│   Database  │  │   Storage   │  │   Uploads       │
│  (blog.db)  │  │  (articles/)│  │   (uploads/)    │
└─────────────┘  └─────────────┘  └─────────────────┘
```

### Структура каталогов

```
blog-project/
├── server.js                     # Основной серверный файл (Express)
├── database.js                   # Логика работы с SQLite и файлами
├── blog.db                       # SQLite база данных (метаданные)
├── articles/                     # Основное хранилище статей
│   ├── 1/                        # Папка статьи ID=1
│   │   ├── content.html          # HTML-контент статьи
│   │   ├── info.json             # Метаданные статьи (резервная копия)
│   │   └── assets/               # Изображения и файлы статьи
│   │       ├── 1700000000000-abc123.jpg
│   │       └── 1700000000001-def456.png
│   ├── 2/
│   └── ...
├── uploads/                      # Временная папка для загрузок (Multer)
├── public/                       # Статические файлы клиентской части
│   ├── index.html                # Главная страница со списком статей
│   ├── editor.html               # WYSIWYG редактор статей
│   ├── post.html                 # Страница просмотра статьи
│   ├── login.html                # Страница входа в систему
│   ├── setup.html                # Страница создания первого администратора
│   ├── preview.html              # Страница предпросмотра статьи
│   └── style.css                 # Базовые стили
└── package.json                  # Зависимости проекта
```

## Технологический стек

**Серверная часть:**
- **Node.js** (v14+) - серверная платформа
- **Express** (v4.x) - веб-фреймворк
- **better-sqlite3** (v8.x) - клиент SQLite
- **Multer** (v1.x) - обработка загрузки файлов
- **Express-session** (v1.x) - управление сессиями
- **Crypto** (встроенный модуль) - хеширование паролей

**Клиентская часть:**
- **Quill.js** (v1.3.7) - WYSIWYG редактор
- **Vanilla JavaScript** - логика фронтенда
- **CSS3** - стилизация

**Хранение данных:**
- **SQLite3** - реляционная база для метаданных
- **Файловая система** - основное хранилище контента

## Функциональные возможности

### 1. Система аутентификации и авторизации
- Первичная настройка с созданием администратора
- Сессионная аутентификация с хешированием паролей (scrypt)
- Middleware защиты административных маршрутов
- Автоматическая проверка наличия администратора при запуске

### 2. Управление контентом
- Создание, редактирование, удаление статей
- WYSIWYG редактор с поддержкой форматирования
- Загрузка изображений с локального диска и по URL
- Интерактивные блоки копирования через теги [block]
- Автосохранение черновиков в localStorage

### 3. Хранение и доступ
- Гибридное хранение: метаданные в SQLite, контент в файлах
- Восстановление базы данных из файловой структуры
- Поддержка ассетов (изображений) для каждой статьи
- Быстрый доступ к списку статей через SQLite

### 4. Пользовательский интерфейс
- Адаптивный дизайн для мобильных устройств
- Интуитивный редактор с предпросмотром
- Понятная навигация между статьями
- Административная панель для управления контентом

## Структура данных

### SQLite схема

```sql
-- Таблица пользователей (только администраторы)
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,     -- Хеш пароля (scrypt)
  salt TEXT NOT NULL               -- Соль для хеширования
);

-- Таблица метаданных статей
CREATE TABLE posts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,             -- Заголовок статьи
  slug TEXT UNIQUE NOT NULL,       -- URL-совместимый идентификатор
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### Файловая структура статьи

Каждая статья хранится в отдельной папке с именем, соответствующим ID статьи:

```
articles/1/
├── content.html      # Основной HTML контент статьи
├── info.json         # Метаданные статьи (дублирование из SQLite)
└── assets/           # Папка с изображениями статьи
    ├── 1700000000000-abc123.jpg
    └── 1700000000001-def456.png
```

## API Endpoints

### Аутентификация
| Метод | Путь | Описание | Доступ |
|-------|------|----------|--------|
| GET | `/api/admin-exists` | Проверка существования администратора | Публичный |
| POST | `/api/setup-admin` | Создание первого администратора | Публичный |
| POST | `/api/login` | Вход в систему | Публичный |
| POST | `/api/logout` | Выход из системы | Авторизованные |
| GET | `/api/me` | Получение информации о текущем пользователе | Публичный |

### Управление статьями
| Метод | Путь | Описание | Доступ |
|-------|------|----------|--------|
| GET | `/api/posts` | Получение списка всех статей | Публичный |
| GET | `/api/post/:id` | Получение полной статьи с контентом | Публичный |
| POST | `/api/posts` | Создание новой статьи | Только администратор |
| PUT | `/api/post/:id` | Обновление существующей статьи | Только администратор |
| DELETE | `/api/post/:id` | Удаление статьи | Только администратор |

### Работа с файлами
| Метод | Путь | Описание | Доступ |
|-------|------|----------|--------|
| POST | `/api/upload-image/:postId` | Загрузка изображения для статьи | Только администратор |
| GET | `/api/article-asset/:postId/:filename` | Получение файла ассета | Публичный |
| POST | `/api/rebuild-database` | Восстановление БД из файлов | Только администратор |

## Рабочий процесс

### Типичные сценарии использования

**1. Первый запуск системы:**
```
Пользователь → Открывает http://localhost:3000/
Система → Проверяет наличие администратора → Перенаправляет на /setup.html
Пользователь → Создает учетную запись администратора
Система → Перенаправляет на /login.html
Пользователь → Вводит учетные данные
Система → Авторизует пользователя → Перенаправляет на главную страницу
```

**2. Создание новой статьи:**
```
Администратор → Нажимает "+ Новая статья"
Система → Открывает редактор (editor.html)
Администратор → Вводит заголовок и контент, загружает изображения
Администратор → Нажимает "Сохранить статью"
Система → Создает запись в SQLite → Создает папку статьи → Сохраняет контент в файлы
Система → Перенаправляет на страницу статьи
```

**3. Восстановление после сбоя:**
```
Администратор → Удаляет blog.db файл
Администратор → Запускает сервер с флагом REBUILD_DB=true
Система → Сканирует папку articles/ → Восстанавливает метаданные в SQLite
Система → Готова к работе с сохраненными статьями
```

## Система безопасности

### 1. Аутентификация и авторизация
- Хеширование паролей с использованием алгоритма scrypt
- Уникальная соль для каждого пользователя
- Сессионные куки с ограниченным временем жизни
- Middleware проверки прав доступа для всех административных операций

### 2. Защита данных
- Prepared statements для всех SQL-запросов
- Валидация типов и размеров загружаемых файлов
- Ограничение доступа к папкам статей только через API
- Проверка MIME-типов для загружаемых изображений

### 3. Безопасность файловой системы
- Изоляция статей в отдельных директориях
- Уникальные имена файлов для предотвращения коллизий
- Очистка временных файлов после обработки
- Проверка прав доступа к файлам и папкам

## Установка и запуск

### Требования
- Node.js версии 14 или выше
- npm или yarn для управления зависимостями
- Доступ к файловой системе для записи

### Установка

```bash
# Клонирование репозитория (пример)
git clone <repository-url>
cd blog-project

# Установка зависимостей
npm install

# Запуск сервера
node server.js

# Альтернативные способы запуска
PORT=4000 node server.js
REBUILD_DB=true node server.js
```

### Доступные URL

- **Главная страница:** http://localhost:3000/
- **Редактор статей:** http://localhost:3000/editor.html
- **Просмотр статьи:** http://localhost:3000/post.html?id=<ID>
- **Страница входа:** http://localhost:3000/login.html
- **Создание администратора:** http://localhost:3000/setup.html
- **Предпросмотр:** http://localhost:3000/preview.html

## Назначение info.json

Файл `info.json` выполняет несколько критически важных функций в системе:

### 1. Резервное копирование метаданных
```json
{
  "id": 1,
  "title": "Заголовок статьи",
  "slug": "zagolovok-stati",
  "created_at": "2025-12-15T10:30:00.000Z",
  "updated_at": "2025-12-15T10:30:00.000Z"
}
```

**Назначение:** Сохраняет метаданные статьи независимо от базы данных SQLite. В случае повреждения или удаления `blog.db` файла, система может восстановить структуру базы данных из этих файлов.

### 2. Обеспечение целостности данных
- Содержит те же данные, что и запись в таблице `posts` SQLite
- Позволяет проверять согласованность данных между файловой системой и базой данных
- Служит точкой восстановления при миграциях или обновлениях системы

### 3. Поддержка операций восстановления
Функция `rebuildDatabaseFromFiles()` использует `info.json` для:
- Восстановления структуры базы данных после сбоя
- Миграции на другую систему хранения данных
- Создания резервных копий, независимых от конкретной СУБД

### 4. Долгосрочная сохранность данных
- Формат JSON обеспечивает читаемость данных
- Независимость от конкретной версии SQLite или схемы базы данных
- Возможность ручного редактирования или восстановления при необходимости

## Достоинства и недостатки

### Достоинства системы

**1. Надежность и отказоустойчивость**
- Двойное хранение данных: SQLite для метаданных + файлы для контента
- Возможность полного восстановления из файловой системы
- Независимость от состояния базы данных

**2. Производительность**
- Быстрый доступ к списку статей через SQLite индексы
- Эффективная загрузка контента из файлов (особенно для больших статей)
- Отсутствие накладных расходов на хранение HTML в базе данных

**3. Масштабируемость**
- Файловая система лучше справляется с большими объемами медиа-контента
- Возможность распределения статей по разным дискам или серверам
- Простое резервное копирование (копирование папки `articles/`)

**4. Гибкость**
- Легкая миграция на другую СУБД или систему хранения
- Возможность прямого доступа к файлам для анализа или обработки
- Простая интеграция с системами контроля версий (Git для папки `articles/`)

**5. Простота развертывания**
- Минимальные зависимости (только Node.js и SQLite)
- Отсутствие необходимости в отдельном сервере баз данных
- Портативность (можно запустить на любом сервере с Node.js)

### Недостатки и ограничения

**1. Сложность транзакций**
- Отсутствие атомарности между операциями с файлами и базой данных
- Возможность рассинхронизации между SQLite и файловой системой
- Необходимость ручной очистки при частичном выполнении операций

**2. Ограничения производительности при большом количестве файлов**
- Файловая система может стать узким местом при тысячах статей
- Нет встроенной индексации по содержимому файлов
- Поиск по контенту требует полного сканирования файлов

**3. Безопасность**
- Хранение файлов в открытом доступе требует дополнительной защиты
- Риск прямого доступа к файлам в обход системы авторизации
- Необходимость контроля прав доступа к файловой системе

**4. Сложность резервного копирования**
- Необходимость синхронизации резервных копий базы данных и файлов
- Риск несоответствия версий между SQLite и файлами
- Отсутствие встроенных механизмов для инкрементных бэкапов

**5. Ограничения функциональности**
- Отсутствие полнотекстового поиска по статьям
- Нет поддержки категорий, тегов или таксономий
- Ограниченная система прав доступа (только администратор/гость)

**6. Масштабируемость на уровне сети**
- Сложности с распределенным хранением файлов
- Отсутствие поддержки CDN для медиа-контента
- Ограничения при горизонтальном масштабировании

## Возможные улучшения

### Краткосрочные улучшения

1. **Пагинация и фильтрация** на главной странице
2. **Поиск по статьям** с поддержкой полнотекстового поиска
3. **Система категорий и тегов** для организации контента
4. **SEO оптимизация** (meta-теги, чистая разметка, sitemap)

### Среднесрочные улучшения

1. **Кэширование** статей в памяти для увеличения производительности
2. **CDN интеграция** для хранения и раздачи изображений
3. **Интернационализация** (поддержка нескольких языков)
4. **API для мобильных приложений** с токен-аутентификацией

### Долгосрочные улучшения

1. **Миграция на объектное хранилище** (S3, Google Cloud Storage)
2. **Реализация версионирования** статей с историей изменений
3. **Система комментариев** и социальных взаимодействий
4. **Аналитика** просмотров и вовлеченности пользователей

## Заключение

Данный проект представляет собой работоспособную систему ведения блога с уникальной архитектурой гибридного хранения данных. Система демонстрирует хороший баланс между простотой, надежностью и функциональностью, что делает ее подходящей для небольших и средних проектов.

**Ключевые преимущества:**
- Автономность и самовосстанавливаемость
- Простота развертывания и обслуживания
- Эффективное хранение медиа-контента
- Гибкость и возможность кастомизации

**Области применения:**
- Личные и корпоративные блоги
- Системы документации
- Портфолио проектов
- Образовательные платформы с контентом

**Требуемая доработка для production-использования:**
- Усиление системы безопасности
- Реализация полноценного бэкапа
- Оптимизация производительности при больших объемах данных
- Добавление мониторинга и логирования

---

**Дата создания документации:** Декабрь 2025  
**Версия системы:** 0.1  
**Статус:** Рабочий прототип, готовый к расширению
